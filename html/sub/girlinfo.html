<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<link href="../../css/mui.min.css" rel="stylesheet" />
<link href="../../css/list-to-detail.css" rel="stylesheet" />
<link href="../../css/style.css" rel="stylesheet" />
</head>

<body>
<div class="mui-content">
	<div id="demo1" class="mui-progressbar">
		<span></span>
	</div>
	<!--顶部banner图 开始-->
	<div id="kr-article-banner" class="kr-article-banner">
		<div id="kr-article-cover" class="kr-article-cover">
			<img :src="cover">
		</div>
		<h2 id="kr-article-title" class="kr-article-title">{{title}}</h2>
	</div>
	<!--顶部banner图 结束-->
	
	
	
	
	<div class="kr-article-content">
		<!-- 文章作者、发布时间等信息 -->
		<div class="kr-article-meta">
			<div id="kr-article-author" class="kr-article-author">{{author}}</div>
			<div class="kr-article-text">发表于</div>
			<div id="kr-article-time" class="kr-article-time">{{time}}</div>
			
		</div>
		<!--文章详细内容-->
		<div id="kr-article-article" class="kr-article-article" v-html="content">{{listen_url}}</div>
	</div>
</div>

<style>
#player {
	display: block;
	position: fixed;
	width: 100%;
	height: 44px;
	bottom: 0;
}
#stop {
	display: none;
}
#stop,#showImg,.mui-btn {
	width: 50px;
	margin: 0 auto;
}
</style>
<div id="player">
	<div id="showImg"></div>
	<div id="stop" class="stop mui-btn" onclick="stopPlay();">停止</div>
</div>

<script src="../../js/mui.min.js"></script>
<script src="../../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	mui.init();

	// 扩展API加载完毕后调用onPlusReady回调函数 
	document.addEventListener( "plusready", onPlusReady, false );
	// 扩展API加载完毕，现在可以正常调用扩展API 
	
		var myplayer = document.getElementById("showImg");
	function onPlusReady() {
		
//		mui('#audioList').on('click', 'li', function(){
//			console.log(this.innerHTML);
//		});
		
		//监听点击事件
		myplayer.addEventListener("tap",function () {
			console.log("tap event trigger");
			var loadUrl = vm.listen_url;
			var filename = loadUrl.substring(loadUrl.lastIndexOf("/") + 1, loadUrl.length);
            var relativePath = "_downloads/" + filename;
			startPlay(relativePath);
		});
            
		
		
		
	}
	
	
	
	function getDefaultData() {
		return {
			cover: '',
			title: '',
			author: '',
			time: '',
			listen_url: '',
			content: ''
		}
	}

	var vm = new Vue({
		el: '.mui-content',
		data: getDefaultData(),
		methods: {
			resetData: function() {//重置数据
				Object.assign(this.$data, getDefaultData());
			}
		}
	});

	

	//监听自定义事件，获取新闻详情
	document.addEventListener('get_detail', function(event) {
		var guid = event.detail.guid;
		if(!guid) {
			return;
		}
		//前页传入的数据，直接渲染，无需等待ajax请求详情后
		vm.cover = event.detail.cover;
		vm.title = event.detail.title;
		vm.author = event.detail.author;
		vm.time = event.detail.time;
		vm.listen_url = event.detail.listen_url;
		
		document.getElementById("showImg").innerHTML = "<div id='"+guid+"' class='mui-btn'>播放</div>";
		setImg(guid, vm.listen_url);
		
		//向服务端请求文章详情内容
		mui.ajax('http://www.zlhpy.com/musicapi.php?' + guid, {
			type:'GET',
			dataType: 'json', //服务器返回json格式数据
			timeout: 15000, //15秒超时
			success: function(rsp) {
				//vm.listen_url = rsp.listen_url;
				vm.content = rsp.content;
			},
			error: function(xhr, type, errorThrown) {
				mui.toast('获取文章内容失败');
				//TODO 此处可以向服务端告警
			}
		});
	});

	//重写返回逻辑
	mui.back = function() {
		plus.webview.currentWebview().hide("auto", 300);
		//动画结束后，恢复默认值
		setTimeout(function() {
			window.scrollTo(0, 0);
			vm.resetData();
		}, 300);
	};
	
	document.addEventListener("swiperight",function(){
	    mui.back();
	    stopPlay();
	});
</script>

<script type="text/javascript" src="../../js/download.audio.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript">
// 播放文件相关对象
var p=null,pt=null,pp=null,ps=null,pi=null;
var ep=null;

// DOMContentLoaded事件处理
document.addEventListener('DOMContentLoaded', function(){
	// 获取DOM元素对象
	ep = document.getElementById('stop');
	startplay = document.getElementById('showImg');
	//updateHistory();
},false);



// 开始播放
function startPlay(url){
	//ep = document.getElementById('play');
	ep.style.display = 'block';
	startplay.style.display = 'none';
	mui("#demo1").progressbar({progress:0}).show();

	p = plus.audio.createPlayer(url);
	p.play(function(){
		// 播放完成
		stopPlay();
	}, function(e){
		//outLine('播放音频文件"'+url+'"失败：'+e.message);
	});
	// 获取总时长
	var d = p.getDuration();
	
	pi = setInterval(function(){
		var c = p.getPosition();
		var pct = Math.round(c/d*100,2);
		mui("#demo1").progressbar().setProgress(pct);
	}, 1000);
}
// 停止播放
function stopPlay(){
	clearInterval(pi);
	mui("#demo1").progressbar().setProgress(100);
	mui("#demo1").progressbar().hide();
	setTimeout(resetPlay, 500);
	// 操作播放对象
	if(p){
		p.stop();
		p=null;
	}
}
// 重置播放页面内容
function resetPlay(){
	ep.style.display = 'none';
	startplay.style.display = 'block';
}
// 重写关闭
var _back=window.back;
function resetback(){
	// 停止播放
	if(ep.style.display == 'block'){
		stopPlay();
	}else{
		//_back() = mui.back();
	}
}
window.back=resetback;
</script>




</body>

</html>